{% extends "base.html" %}

{% block title %}Book {{ car.make }} {{ car.model }}{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h3 class="mb-0">Book {{ car.make }} {{ car.model }}</h3>
                        <span class="badge bg-light text-primary fs-6">{{ car.year }}</span>
                    </div>
                </div>
                
                <div class="card-body">
                    <div class="row mb-4 g-4">
                        <div class="col-md-6">
                            <div class="position-relative">
                                {% if car.image_url %}
                                <img src="{{ car.image_url }}" class="img-fluid rounded-3" 
                                     alt="{{ car.make }} {{ car.model }}"
                                     style="height: 300px; width: 100%; object-fit: cover;">
                                {% else %}
                                <div class="d-flex flex-column align-items-center justify-content-center bg-light rounded-3 p-5" 
                                     style="height: 300px;">
                                    <i class="fas fa-car fa-4x text-secondary mb-3"></i>
                                    <p class="text-muted mb-0">No Image Available</p>
                                </div>
                                {% endif %}
                                <div class="position-absolute bottom-0 end-0 bg-white px-3 py-1 rounded-start shadow-sm">
                                    <span class="fw-bold text-primary fs-5">KES {{ "{:,.2f}".format(car.price_per_day) }}</span>
                                    <span class="text-muted small">/day</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="h-100 d-flex flex-column">
                                <div class="mb-3">
                                    <h4 class="mb-3">{{ car.make }} {{ car.model }}</h4>
                                    
                                    <div class="row g-2 mb-3">
                                        <div class="col-6">
                                            <div class="p-2 bg-light rounded">
                                                <small class="text-muted d-block">Engine</small>
                                                <strong>{{ car.engine_capacity }}L</strong>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="p-2 bg-light rounded">
                                                <small class="text-muted d-block">Transmission</small>
                                                <strong>{{ car.transmission|capitalize }}</strong>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="p-2 bg-light rounded">
                                                <small class="text-muted d-block">Seats</small>
                                                <strong>{{ car.seating_capacity }}</strong>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="p-2 bg-light rounded">
                                                <small class="text-muted d-block">Fuel</small>
                                                <strong>{{ car.fuel_type|capitalize }}</strong>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {% if car.description %}
                                    <div class="alert alert-light">
                                        <i class="fas fa-info-circle text-primary me-2"></i>
                                        {{ car.description }}
                                    </div>
                                    {% endif %}
                                </div>
                                
                                <div class="mt-auto">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-check-circle text-success me-2"></i>
                                        <small class="text-muted">Currently Available</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <form method="POST" action="{{ url_for('new_booking', car_id=car.id) }}" id="bookingForm">
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label for="start_date" class="form-label fw-bold">Pick-up Date</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-white"><i class="fas fa-calendar-alt text-primary"></i></span>
                                    <input type="date" class="form-control" id="start_date" name="start_date" 
                                           min="{{ today.strftime('%Y-%m-%d') }}" 
                                           value="{{ today.strftime('%Y-%m-%d') }}" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="end_date" class="form-label fw-bold">Return Date</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-white"><i class="fas fa-calendar-alt text-primary"></i></span>
                                    <input type="date" class="form-control" id="end_date" name="end_date" 
                                           min="{{ tomorrow.strftime('%Y-%m-%d') }}" 
                                           value="{{ tomorrow.strftime('%Y-%m-%d') }}" required>
                                </div>
                            </div>
                        </div>
                        <div class="card border-primary mb-4">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">
                                    <i class="fas fa-receipt text-primary me-2"></i>
                                    Booking Summary
                                </h5>
                            </div>
                            <div class="card-body">
                                <div id="booking-summary">
                                    <div class="text-center text-muted py-4">
                                        <i class="fas fa-calendar-check fa-2x mb-3"></i>
                                        <p class="mb-0">Select your rental dates to see details</p>
                                    </div>
                                </div>
                                <div id="availability-message" class="mt-3"></div>
                            </div>
                        </div>
                        <div class="d-grid gap-3 d-md-flex justify-content-md-end">
                            <a href="{{ url_for('car_details', car_id=car.id) }}" class="btn btn-outline-secondary px-4">
                                <i class="fas fa-arrow-left me-2"></i> Back to Details
                            </a>
                            <button type="submit" class="btn btn-primary px-4" id="submitBtn">
                                <i class="fas fa-check-circle me-2"></i> Confirm Booking
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const startDateInput = document.getElementById('start_date');
    const endDateInput = document.getElementById('end_date');
    const bookingSummary = document.getElementById('booking-summary');
    const availabilityMessage = document.getElementById('availability-message');
    const submitBtn = document.getElementById('submitBtn');
    const dailyRate = {{ car.price_per_day }};
    
    function formatDate(date) {
        return date.toLocaleDateString('en-US', { 
            weekday: 'short', 
            year: 'numeric', 
            month: 'short', 
            day: 'numeric' 
        });
    }
    function calculateDays(start, end) {
        return Math.floor((end - start) / (1000 * 60 * 60 * 24)) + 1;
    }
    function updateBookingSummary() {
        const startDate = new Date(startDateInput.value);
        const endDate = new Date(endDateInput.value);
        
        if (startDate && endDate && startDate <= endDate) {
            const days = calculateDays(startDate, endDate);
            const totalCost = days * dailyRate;
            bookingSummary.innerHTML = `
                <div class="text-center py-2">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Checking availability...</p>
                </div>
            `;
            fetch(`/api/check_availability/{{ car.id }}?start_date=${startDateInput.value}&end_date=${endDateInput.value}`)
                .then(response => {
                    if (!response.ok) throw new Error('Network error');
                    return response.json();
                })
                .then(data => {
                    if (data.available) {
                        bookingSummary.innerHTML = `
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <small class="text-muted d-block">Pick-up</small>
                                        <strong>${formatDate(startDate)}</strong>
                                    </div>
                                    <div class="mb-3">
                                        <small class="text-muted d-block">Duration</small>
                                        <strong>${days} day(s)</strong>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <small class="text-muted d-block">Return</small>
                                        <strong>${formatDate(endDate)}</strong>
                                    </div>
                                    <div class="mb-3">
                                        <small class="text-muted d-block">Daily Rate</small>
                                        <strong>KES ${dailyRate.toFixed(2)}</strong>
                                    </div>
                                </div>
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Total Cost</h5>
                                <h4 class="mb-0 text-primary">KES ${totalCost.toFixed(2)}</h4>
                            </div>
                        `;
                        
                        availabilityMessage.innerHTML = `
                            <div class="alert alert-success d-flex align-items-center">
                                <i class="fas fa-check-circle me-2"></i>
                                <div>This vehicle is available for your selected dates</div>
                            </div>
                        `;
                        submitBtn.disabled = false;
                    } else {
                        bookingSummary.innerHTML = `
                            <div class="text-center py-3">
                                <i class="fas fa-times-circle fa-2x text-danger mb-3"></i>
                                <h5 class="mb-2">Not Available</h5>
                                <p class="text-muted">Please select different dates</p>
                            </div>
                        `;
                        
                        availabilityMessage.innerHTML = `
                            <div class="alert alert-danger d-flex align-items-center">
                                <i class="fas fa-times-circle me-2"></i>
                                <div>This vehicle is not available for the selected dates</div>
                            </div>
                        `;
                        submitBtn.disabled = true;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    bookingSummary.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Error checking availability. Please try again.
                        </div>
                    `;
                    submitBtn.disabled = true;
                });
        } else {
            bookingSummary.innerHTML = `
                <div class="text-center text-muted py-4">
                    <i class="fas fa-calendar-check fa-2x mb-3"></i>
                    <p class="mb-0">Select valid dates to see booking details</p>
                </div>
            `;
            availabilityMessage.innerHTML = '';
            submitBtn.disabled = true;
        }
    }
    startDateInput.addEventListener('change', function() {
        endDateInput.min = this.value;
        if (new Date(endDateInput.value) < new Date(this.value)) {
            endDateInput.value = this.value;
        }
        updateBookingSummary();
    });
    
    endDateInput.addEventListener('change', updateBookingSummary);
    updateBookingSummary();
});
</script>
{% endblock %}